stages:
  - generate
  - deploy

.deploy_template:
  image: python:3.9
  stage: deploy
  before_script:
    - pip install --quiet awscli
  needs:
    - job: auto_generate_configs
      artifacts: true
  dependencies:
    - auto_generate_configs

auto_generate_configs:
  image: python:3.9
  stage: generate
  before_script:
    - apt-get update -y && apt-get install -y make git
  script:
    - make build env=all
  artifacts:
    paths:
      - configs/
    expire_in: 1 day
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - when: never

deploy_test_configs:
  extends: .deploy_template
  script:
    - aws s3 sync configs/test s3://thetradedesk-mlplatform-us-east-1/configdata/confetti/configs/test/
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - when: never

deploy_config_templates:
  extends: .deploy_template
  script:
    - aws s3 sync config-templates s3://thetradedesk-mlplatform-us-east-1/configdata/confetti/config-templates/ --delete
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - when: never

# prod are force to sync in clean status.
deploy_prod_configs:
  extends: .deploy_template
  script:
    - aws s3 sync configs/prod s3://thetradedesk-mlplatform-us-east-1/configdata/confetti/configs/prod/ --delete
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - when: never

# experiment are force to sync in clean status.
deploy_experiment_configs:
  extends: .deploy_template
  script:
    - aws s3 sync configs/experiment s3://thetradedesk-mlplatform-us-east-1/configdata/confetti/configs/experiment/ --delete
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - when: never
